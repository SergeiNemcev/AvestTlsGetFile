## Описание
Утилита является альтернативой IE и ПО "Шина данных" для клиента АС "Электронная перевозка" Белорусской ЖД. 
Предназначается только для закачки данных с сервера железной дороги АС "Электронная перевозка" 
через протокол TLS используя криптопровайдер ЗАО "Авест" AvCSP.
Данные сохраняются в указанный файл на локальном или сетевом диске. Настройки пользователя 
находятся в текстовом файле конфигурации. Некоторые настройки пользователя возможно задать 
через командную строку.

Проект создан на примере ClientCSP Microsoft с установками криптопровайдера AvCSP.

Скомпилирован в VS2015 C++.

#### Использованы функции библиотек: 
- **CryptoAPI** - для доступа к сертификату пользователя, функции (де)шифрования данных.
- **SSPI** - для работы через сеть Internet по протоколу TLS (установка соединения, получение - отправка данных)
- **WinAPI, стандартная C++**	- чтение файла конфигурации, запись лога и пр.

#### Размещение каталогов:
- **Test** - готовое решение в одном каталоге (необходимо настроить файл конфигурации для конкретного пользователя)
- **Project**  - исходный проект в VS2015 C++.

## Требование
На машине клиента должен быть установлен криптопрвайдер AvCSP и соответствующие сертификаты 
Центра защиты информации БелЖД для доступа к АС "Электронная перевозка".

Internet Explorer и ПО "Шина данных" не требуется.

## Что качаем
В настоящее время (ноябрь 2017) возможно закачивать следующее:
- Заявки на подачу вагонов (ГУ-12) за период в формате XML (https://ep.isc.by/ep/export?dat_bgn=yyyy-MM-dd&dat_end=yyyy-MM-dd)
- НСИ, используемые в АС в формате XML (https://ep.isc.by/ep/downloadNSI?type=XML&table= ...)
		доступны таблицы: ACCOMP_FORMS, CARGO, CARGO_ETSNG_GNG, CARGO_GNG, CONSIGN_BCH, FORWARD_BCH, FORWARDER, LOCKING_ARM,
		MANAGEMENT, MASS, ROAD, STA, TARE_SMGS, VAGON_KIND, VAGON_TYPE
- Жд накладные (ГУ-29, СМГС) в формате ZIP, который содержит перечень подписанных накладных в формате P7B (обвертка для XML)
		В запросе должно быть указано перечень eid (индификатор в АС "Электронная перевозка") накладных.
		(https://ep.isc.by/ep/exportDocs?doc_type=nakl&eids= ...)

## Описание настроек
#### Пользовательские настройки в файле конфигурации:
``` 
;Файл для логирования
[log]
;Путь относительный или полный и имя файла (Каталог должен быть создан заранее с правом записи)	
log_file = "\log\AvestTSC_GetFile.log"
;Максимальный размер лог файла в килобайтах. При достижении max размера - файл усекается примерно на половину.
max_size=2048

;;Если доступ к сети Internet через прокси
[proxy]
useProxy=0	;(Да=1 или Нет=0)
nameProxy = "192.168.0.1" ;или "my_proxy"
portProxy=8080

;;Сервер и порт для доступа к данным АС "Электронная перевозка"
[server]
nameServer = "ep.isc.by"
portServer=443

;;Следующие переменные "по умолчанию", 
;;т.е. если не будут указаны в командной строке запускаемого exe файла.
;;Данные для доступа к сертификату:
[certificate]
		; Одно из значений поля Субъект в составе сертификата - для однозначного выбора сертификата из личного хранилища.
		; см. в IE - "Свойства браузера" - "Содержание" - "Сертификаты" - выделить сертификат - "Просмотр" - "Состав" - выбрать поле "Субъект"
		; Если не задать (или не найдено) - выход из программы.
subject="user007@oao_zzz.by"  (обычно ЦЗИ БелЖД задает в описании Субъект email пользователя, можно указать что-то другое из полей "Субъект",
									главное, чтобы в другом сертификате, в этом хранилище, не было этого описания) 
		; Пин код для контейнера сертификата. 
		; Если не указан (или неправильно, или ошибка инициализации контейнера) - будет отображено окно для ввода пароля пользователя. 
pass="12345678"

;Строка с параметрами на сервере для импорта требуемых данных. 
[params]
fromFile="ep/downloadNSI?type=XML&table=ROAD"
		;Сохранить результат в файл. Файл будет создан или перезаписан. 
		;Указать путь относительно текущего или полный (Каталог должен быть создан заранее с правом записи).
toFile="D:\Download_EP\NewFile.xml"
```

#### Описание командной строки запускаемой утилиты:
```
ВНИМАНИЕ!! Обозначение параметров без знака '-', значение параметра сразу за ':'(без пробела )
conf: - путь к файлу конфигурации, если не указать, файл по умолчанию будет искаться в текущем каталоге.
log:  - путь к файлу логирования, если не указать, файл по умолчанию будет записан в текущий каталог.
			Каталог для лога должен быть с правом записи.
user:  - одно из значений поля Субъект в составе сертификата - для однозначного выбора сертификата из личного хранилища.
pass:  - пин пароль к контейнеру сертификата, если указать неверно - будет выведено окно для ввода пароля.
from:  - путь с параметрами на сервере.
file:  - файл с расширением для сохранения данных с сервера. Файл будет перезаписан или создан.
      		Если указан полный путь, то каталог должен быть с соответствующими правами на запись.
?, help, HELP -  справка 
```
## Пример (одной строкой):
```
AvestTLS_GetFile.exe conf:"c:\Мои документы\GetFile.ini" log:"D:\DownLoad from EP\mylog.log" user:"Иванов Петр Петрович" pass:87654321 from:"ep/downloadNSI?type=XML&table=STA" file:"D:\DownLoad from EP\FromEP.xml"
```
	
>Файл exe можно запускать без параметров или с любым количеством. 
>Обязательно должен быть файл конфигурации с основными настройками.
>**Параметры из командной строки более приоритетны, чем в файле конфигурации.**


## Ссылки:
- [АС "Электронная перевозка"](https://ep.isc.by)
- [Центр защиты информации БелЖД](http://www.isc.by/isc/index.do)
- [ЗАО "АВЕСТ"](http://avest.by)



